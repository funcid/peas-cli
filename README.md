# peas-cli

**Проблематика:**

1. **Critical:** Во время множественного скачивания тяжелого файла с одного или нескольких серверов, может произойти отказ в обслуживании из-за высокой и неравномерной нагрузки
2. **Critical:** В случае завершения работы дистрибьютора, entrypoint для загрузки будет утерян
3. **High:** Сервер может находиться в другом регионе, что сильно повышает latency
4. **High:** Протокол загрузки сильно зависит от дистрибьютора, поэтому может быть использован неоптимальный

![Централизованная раздача файла (1).png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/9ca0c609-73fb-430c-ab51-5657a509f513/%D0%A6%D0%B5%D0%BD%D1%82%D1%80%D0%B0%D0%BB%D0%B8%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%BD%D0%B0%D1%8F_%D1%80%D0%B0%D0%B7%D0%B4%D0%B0%D1%87%D0%B0_%D1%84%D0%B0%D0%B9%D0%BB%D0%B0_(1).png)

**Решение:**

        Необходимо создать несколько источников раздачи файла, однако тогда получатель будет знать все хосты, которые уже получили фрагменты файла (далее будет использовано слово - **партиция**). Это необходимый trade-off для достижения параллельного получения фрагментов. По сути, каждый клиент становится сервером раздачи (далее будет использовано слово - **трекер**). 

Вопрос: откуда скачивающий узнает о всех трекерах? 

1. Дистрибьютор создает .peas файл, указывая свой IP-адрес, хэш-сумму файла и различные мета-данные
2. Клиент, как либо, получает .peas файл и переходит по указанному адресу
3. Сервер записывает адрес нашего клиента в этот же .peas файл и уведомляет всех трекеров
4. Клиент, наблюдая в .peas файле, таких же клиентов, начинает запрашивать у них партиции       
    
    ![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/972815a6-ac1b-4252-ba57-8888ee66a033/Untitled.png)
    

**Область применения:**

1. Оптимизация механизма репликации баз данных (нужно доказать на примерах)
2. Ускорение отправки snapshot версий на несколько backup серверов
3. Выпуск большого обновления клиентской части какой-либо игры
4. Быстрая загрузка первичного ПО на только что купленные хосты (+ansible)

**Что отдаем взамен:**

1. Приходится доверять .peas файлу
2. Все участники знают адреса друг друга
3. Trade-off между ускорением на мультисессионной загрузке и вариацией хэш-сумм (поэтому на маленьких файлах, скорость может только замедлиться) 
4. Слабая защита на бесконечное добавление IP-адресов владельцев в peas файл (нужно придумать механизировано актуализации владельцев, например по времени)

**Подробнее про раздачу и установку:**

Дистрибьютор { A } создал горошину и вписал свой IP во владельцы со всеми партициями, далее клиенты { B, C, D, … } получили по телеграмму горошину, выполнили команду peas install file.peas:

1. Все узнали о владельце A, который разделил файл на N партиций размером M, он по очереди, уникально раздает партиции, которых не хватает 
2. Когда клиенты получили первые партиции, они отправили всем владельцам пакет, о том что, они получили партиции { a, b, c, d, … },  то есть отправили только { A }
3. { A } получил пакеты о изменении количества владельцев и передал эту информацию всем своим клиентам { B, C, D, … }.
4. Клиенты стали и серверами, ведь у них есть партиции которых не хватает и они досягаемы
5. Теперь при получении любым клиентом партиции, все участники раздачи узнают о этом и могут запросить эту же партицию
